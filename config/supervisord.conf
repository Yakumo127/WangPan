[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:mysql]
command=/usr/sbin/mysqld --user=mysql --datadir=/var/lib/mysql --pid-file=/var/run/mysqld/mysqld.pid --socket=/var/run/mysqld/mysqld.sock
autostart=true
autorestart=true
stdout_logfile=/var/log/mysql/mysql.log
stderr_logfile=/var/log/mysql/error.log
priority=100
user=root
startsecs=10
startretries=5

[program:redis]
command=/usr/bin/redis-server /etc/redis/redis.conf
autostart=true
autorestart=true
stdout_logfile=/var/log/redis/redis.log
stderr_logfile=/var/log/redis/redis.log
priority=200
user=root
startsecs=5
startretries=3

[program:backend]
command=/usr/bin/java -Xmx1024m -Xms512m -Djava.security.egd=file:/dev/./urandom -jar /app/app.jar --spring.profiles.active=docker
directory=/app
user=appuser
autostart=true
autorestart=true
stdout_logfile=/app/logs/backend.log
stderr_logfile=/app/logs/backend-error.log
priority=300
startsecs=60
startretries=5
# 等待MySQL和Redis启动完成
depends_on=mysql,redis

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/var/log/nginx/nginx.log
stderr_logfile=/var/log/nginx/error.log
priority=400
user=root

[program:init-admin]
command=/bin/bash -c "sleep 30 && mysql -u root enterprise_file_manager -e \"INSERT IGNORE INTO users (username, password, email, display_name, role, enabled, locked, quota_limit, quota_used, email_verified) VALUES ('admin', '\\$2a\\$10\\$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVYITi', 'admin@example.com', '系统管理员', 'ADMIN', true, false, 1073741824, 0, true);\""
autostart=true
autorestart=false
startretries=3
stdout_logfile=/var/log/supervisor/init-admin.log
stderr_logfile=/var/log/supervisor/init-admin.log
priority=500
user=root